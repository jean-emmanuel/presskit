<BOUCLE_rubrique(RUBRIQUES){id_rubrique=#ENV{id_rubrique}}>
<?php

$title = "[(#TITRE|textebrut|sanitize)]";
$zippath = "tmp/";
$zipname = "dossier_presse_".$title.".zip";

[(#AUTORISER{webmestre}|oui)[(#ENV{mode}|=={refresh}|oui)
	if (file_exists($zippath.$zipname)) {
		@unlink($zippath.$zipname);
	}
]]

if (!file_exists($zippath.$zipname)) {

	function create_zip($files = array(),$destination = "",$overwrite = true) {
		$zip = new ZipArchive();
		if($zip->open($destination,$overwrite ? ZIPARCHIVE::OVERWRITE : ZIPARCHIVE::CREATE) !== true) {
			return false;
		}
		foreach($files as $file) {
				$zip->addFile($file["url"],$file["name"]);
		}
		$zip->close();
		return file_exists($destination);
	}



	$files = array(
  array(
	  url => "#CHEMIN{misc/licence.txt}",
	  name => "Licence.txt"
  ),
	<BOUCLE_images(DOCUMENTS){extension==jpg|gif|png|jpeg}{doublons}{id_rubrique}{","}>
  array(
	  url => "[(#FICHIER|image_reduire{4096}|extraire_attribut{src})]",
	  name => "[(#TITRE|textebrut|sanitize|sinon{image_#COMPTEUR_BOUCLE})]_HD.#EXTENSION"
  ),array(
	  url => "[(#FICHIER|image_reduire{640}|extraire_attribut{src})]",
	  name => "[(#TITRE|textebrut|sanitize|sinon{image_#COMPTEUR_BOUCLE})]_SD.#EXTENSION"
  )
	</BOUCLE_images>
	<BOUCLE_documents(DOCUMENTS){doublons}{extension==odt|pdf}{id_rubrique}>
  ,array(
	  url => "[(#FICHIER)]",
	  name => "[(#TITRE|textebrut|sanitize|sinon{#FICHIER|basename{.#EXTENSION}})].#EXTENSION"
  )
	</BOUCLE_documents>
	);

	$zipfile = create_zip($files,$zippath.$zipname);

}

[(#ENV{mode}|=={refresh}|non)

	$size = filesize($zippath.$zipname); 

	header("Pragma: public");
	header("Expires: 0");
	header("Cache-Control: must-revalidate, post-check=0, pre-check=0");
	header("Cache-Control: public");
	header("Content-Description: File Transfer");
	header("Content-Type: application/zip");
	header("Content-Disposition: attachment; filename=\"".$zipname."\"");
	header("Content-Transfer-Encoding: binary");
	header("Accept-Ranges: bytes");
	header("Content-Length: ".$size);


	ob_clean();
	flush();

	readfile($zippath.$zipname);
]

[(#ENV{mode}|=={refresh}|oui)
[(#AUTORISER{webmestre}|oui)echo "L'archive a été recalculée";$check=1;]
[(#AUTORISER{webmestre}|non)echo "Vous n'avez pas les permissions nécessaires pour recalculer l'archive.";]
]

if ($check==1) {
	echo "<hr/><br/><a href='" . $zippath.$zipname . "'>" . $zipname . "</a><br/>" ;
	$checkzip = new ZipArchive(); 
	$checkzip->open($zippath.$zipname); 
	for( $i = 0; $i < $checkzip->numFiles; $i++ ){ 
		  $stat = $checkzip->statIndex( $i ); 
		  print_r("&nbsp;&nbsp;> " . basename( $stat['name']) . PHP_EOL . '[ '. sprintf('%.1f',$stat['size']/1000) . ' kb ] <br/>'); 
	}
}
?>
</BOUCLE_rubrique>
